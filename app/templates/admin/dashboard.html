{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_css %}
<!-- Only Chart.js logic below the fold now since base.html includes Chart.js -->
<style>
    .stat-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .chart-container-donut {
        position: relative;
        height: 300px;
        width: 100%;
        display: flex;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="bi bi-speedometer2"></i> Admin Dashboard
</h2>

<!-- Statistics Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card stat-card border-primary">
            <div class="card-body text-center">
                <i class="bi bi-file-earmark-text stat-icon text-primary"></i>
                <h3 class="mt-2">{{ total_complaints }}</h3>
                <p class="text-muted mb-0">Total Complaints</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card border-warning">
            <div class="card-body text-center">
                <i class="bi bi-lightning-charge stat-icon text-warning"></i>
                <h3 class="mt-2">{{ active }}</h3>
                <p class="text-muted mb-0">Active (Needs Action)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card border-info">
            <div class="card-body text-center">
                <i class="bi bi-people stat-icon text-info"></i>
                <h3 class="mt-2">{{ total_users }}</h3>
                <p class="text-muted mb-0">Total Users</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card border-success">
            <div class="card-body text-center">
                <i class="bi bi-building stat-icon text-success"></i>
                <h3 class="mt-2">{{ total_departments }}</h3>
                <p class="text-muted mb-0">Departments</p>
            </div>
        </div>
    </div>
</div>

<!-- Lifecycle Quick Stats Row -->
<div class="row g-2 mb-4">
    {% set lifecycle = [
    ('Submitted', 'submitted', status_counts.submitted),
    ('Under Review', 'under-review', status_counts.under_review),
    ('Assigned', 'assigned', status_counts.assigned),
    ('In Progress', 'in-progress', status_counts.in_progress),
    ('On Hold', 'on-hold', status_counts.on_hold),
    ('Resolved', 'resolved', status_counts.resolved),
    ('Rejected', 'rejected', status_counts.rejected),
    ('Closed', 'closed', status_counts.closed),
    ] %}
    {% for label, cls, count in lifecycle %}
    <div class="col-6 col-md-3 col-lg">
        <div class="card text-center p-2 h-100">
            <div class="fw-bold fs-4">{{ count }}</div>
            <span class="badge status-{{ cls }} mt-1">{{ label }}</span>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Charts Row -->
<div class="row mb-4 g-4">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Complaints by Department</h5>
            </div>
            <div class="card-body">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Complaints by Status</h5>
            </div>
            <div class="card-body chart-container-donut">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Complaints DataTable Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-card-list"></i> All Complaints Overview</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle w-100" id="adminComplaintsTable">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for complaint in complaints %}
                            <tr>
                                <td>#{{ complaint.id }}</td>
                                <td>{{ complaint.title[:40] }}{% if complaint.title|length > 40 %}...{% endif %}</td>
                                <td><span class="badge bg-secondary">{{ complaint.department.name }}</span></td>
                                <td><span class="badge status-{{ complaint.current_status|replace(' ', '-')|lower }}">{{
                                        complaint.current_status }}</span></td>
                                <td>{{ complaint.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <a href="{{ url_for('admin.view_complaint', complaint_id=complaint.id) }}"
                                        class="btn btn-sm btn-outline-primary shadow-sm"><i class="bi bi-eye"></i>
                                        View</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-md-4">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <i class="bi bi-person-plus" style="font-size: 2rem; color: #0056b3;"></i>
                <h5 class="mt-3">Manage Users</h5>
                <p class="text-muted">Add, edit, or remove users</p>
                <a href="{{ url_for('admin.manage_users') }}" class="btn btn-primary">
                    Go to Users <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <i class="bi bi-building" style="font-size: 2rem; color: #28a745;"></i>
                <h5 class="mt-3">Manage Departments</h5>
                <p class="text-muted">Add or remove departments</p>
                <a href="{{ url_for('admin.manage_departments') }}" class="btn btn-success">
                    Go to Departments <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <i class="bi bi-file-earmark-bar-graph" style="font-size: 2rem; color: #ffc107;"></i>
                <h5 class="mt-3">View Reports</h5>
                <p class="text-muted">Analytics and statistics</p>
                <a href="{{ url_for('admin.reports') }}" class="btn btn-warning">
                    Go to Reports <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // DataTables Initialization
    $(document).ready(function () {
        $('#adminComplaintsTable').DataTable({
            "order": [[4, "desc"]], // Sort by Date descending
            "pageLength": 10,
            "lengthMenu": [5, 10, 25, 50],
            "language": {
                "emptyTable": "No complaints recorded yet."
            }
        });
    });

    // Complaints by Department Chart
    const ctxDept = document.getElementById('departmentChart').getContext('2d');
    new Chart(ctxDept, {
        type: 'bar',
        data: {
            labels: JSON.parse('{{ dept_labels | tojson | safe }}'),
            datasets: [{
                label: 'Complaints',
                data: JSON.parse('{{ dept_counts | tojson | safe }}'),
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // Complaints by Status Donut Chart
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: JSON.parse('{{ status_chart_labels | tojson | safe }}'),
            datasets: [{
                data: JSON.parse('{{ status_chart_data | tojson | safe }}'),
                backgroundColor: [
                    '#6c757d', // Submitted (Gray)
                    '#dc3545', // Flagged (Red)
                    '#fd7e14', // Under Review (Orange)
                    '#17a2b8', // Assigned (Cyan)
                    '#007bff', // In Progress (Blue)
                    '#ffc107', // On Hold (Yellow)
                    '#e83e8c', // Escalated (Pink)
                    '#28a745', // Resolved (Green)
                    '#343a40', // Rejected (Dark Gray)
                    '#20c997' // Closed (Teal)
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 12
                    }
                }
            }
        }
    });
</script>
{% endblock %}